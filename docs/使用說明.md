# 系統使用說明

## 一、安裝與環境準備

1. **Python 版本**：建議 Python 3.10 以上
2. **安裝依賴套件**
   ```bash
   pip install -r requirements.txt
   ```
   主要依賴：flask、gunicorn、docling、openai、requests、python-dotenv

3. **設定 API Key**
   - 請於專案根目錄建立 .env 檔案，內容如下：
     ```
     OPENAI_API_KEY=你的OpenAI金鑰
     ```
   - 或於 shell 直接 export：
     ```
     export OPENAI_API_KEY=你的OpenAI金鑰
     ```

4. **設定 config.ini**
   - 設定 OpenAI 模型與圖片描述 context 字數
     ```
     [OPENAI]
     active_model=gpt-4-vision-preview

     [FIGURE_DESC]
     context_figure=500
     ```

---

## 二、啟動服務

### Production 啟動（推薦）
```bash
bash run_gunicorn.sh
```
- 預設監聽 0.0.0.0:5000，4 workers，timeout 120 秒

### 開發測試
```bash
python app.py
```
- 預設監聽 127.0.0.1:5000

---

## 三、API 端點與參數

### 1. 上傳文件
- **POST /upload**
- 參數：
  - file：要上傳的文件（pdf, docx, pptx, xlsx）
  - desc_figure：是否啟用圖片描述（true/false，預設 false）
- 範例（Python）：
  ```python
  import requests
  with open("test.docx", "rb") as f:
      files = {"file": ("test.docx", f)}
      data = {"desc_figure": "true"}
      resp = requests.post("http://localhost:5000/upload", files=files, data=data)
  print(resp.json())
  ```

### 2. 查詢狀態
- **GET /status/{dir}**
- 回傳：
  - status: "processing" 或 "finished"
  - content: finished.txt 內容（成功/失敗摘要或錯誤）

### 3. 下載結果
- **POST /download**
- 參數：
  - dir：目錄名稱
- 範例（Python）：
  ```python
  resp = requests.post("http://localhost:5000/download", data={"dir": dir_name})
  with open(f"{dir_name}.zip", "wb") as f:
      f.write(resp.content)
  ```

---

## 四、使用方式 Demo

### 1. Python 全自動範例
請參考 demo_upload_download.py，內容包含：
- 上傳文件（啟用圖片描述）
- 輪詢狀態
- 下載壓縮檔
- 解析 output_document.md 內容

### 2. Bash 指令範例
```bash
# 上傳
curl -F "file=@test.docx" -F "desc_figure=true" http://localhost:5000/upload

# 查詢狀態
curl http://localhost:5000/status/20250828_175404_AWHT

# 下載
curl -X POST -F "dir=20250828_175404_AWHT" http://localhost:5000/download -o 20250828_175404_AWHT.zip
```

---

## 五、output_document.md 說明

- 轉檔後所有內容皆存於 output_document.md
- 每張圖片的 markdown 下方自動插入 OpenAI 圖片描述
- 圖片路徑皆為相對路徑（output_document_artifacts/xxx.png）

---

## 六、常見問題

- **cuDNN/PyTorch 錯誤**：請檢查 CUDA/cuDNN 版本與 LD_LIBRARY_PATH 設定
- **OpenAI API Key 無效**：請確認 .env 或 export 設定正確
- **圖片描述失敗**：請檢查 OpenAI 金鑰、模型名稱與網路連線

---

## 七、其他

- 若需自訂模型、context 字數，請修改 config.ini
- 若需擴充支援更多格式，請參考 docling 官方文件
- 若需自訂圖片描述 prompt，請於 doc_convert_service.py 調整
