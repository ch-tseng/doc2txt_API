# 系統開發文件

## 一、系統簡介

本系統為文件自動轉檔與圖檔描述 API，支援 PDF、DOCX、PPTX、XLSX 等格式上傳，能自動轉為 Markdown，並可選擇將文件內所有圖片送交 OpenAI 進行語意描述，最終產出單一 output_document.md，適合知識管理、AI 文件摘要、RAG 前處理等應用。

---

## 二、主要用到的套件介紹

- **Flask**：輕量級 Web API 框架，負責 HTTP 端點。
- **Gunicorn**：Production-ready WSGI server，適合部署 Flask。
- **docling**：IBM Research 開源的多格式文件解析與結構化工具，支援 PDF、Office、HTML、圖片等格式轉 Markdown/JSON。
- **openai**：OpenAI 官方 Python SDK，支援 GPT-4 Vision 圖片+上下文描述。
- **python-dotenv**：自動載入 .env 檔案，管理 API Key。
- **requests**：用於測試與 demo 的 HTTP 請求。
- **werkzeug**：Flask 依賴的 WSGI 工具。
- **configparser**：讀取 config.ini 參數。
- **base64**：圖片轉 base64 傳給 OpenAI Vision。
- **標準庫**：os、re、threading、pathlib、tempfile、zipfile、logging、datetime、random、string 等。

---

## 三、系統架構

```
[Client] --HTTP/POST/GET--> [Gunicorn+Flask API] --(docling, openai)--> [output_document.md]
```

- **API 入口**：/upload、/status/{dir}、/download
- **非同步處理**：上傳後立即回傳目錄，背景 thread 處理轉檔與圖檔描述
- **檔案結構**：
  - extracted/{dir}/output_document.md
  - extracted/{dir}/output_document_artifacts/（圖檔）
  - extracted/{dir}/finished.txt

---

## 四、程式架構與撰寫方法

- **app.py**：Flask 主程式，定義所有 API 端點，負責參數解析、啟動背景處理。
- **doc_convert_service.py**：文件轉檔與圖檔描述主流程，呼叫 docling 轉檔、openai 圖片描述，產生 output_document.md。
- **utils.py**：工具函式，包含 config 解析、markdown 圖片路徑置換、目錄命名等。
- **demo_upload_download.py**：Python demo，示範上傳、查詢、下載、顯示圖片描述。
- **run_gunicorn.sh**：Production-ready 啟動腳本。
- **requirements.txt**：所有依賴套件。
- **config.ini**：OpenAI 模型與圖檔描述 context 設定。
- **.env**：API Key 管理。

**撰寫原則**：
- 各功能模組化，主流程與工具分離
- 圖片描述與 markdown 產生完全自動化
- 支援 production 部署與多 worker
- 測試與 demo 程式皆可直接執行

---

## 五、開發/維護建議

- 若需擴充支援更多格式，請參考 docling 官方文件
- 若需更換 OpenAI 模型，請修改 config.ini
- 若需自訂圖檔描述 prompt，可於 doc_convert_service.py 調整
- 若需支援多語言，可於 prompt 或 config.ini 設定
